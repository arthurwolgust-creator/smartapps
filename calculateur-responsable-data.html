<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Calculateur – Charge des retraitements</title>

  <!-- Tailwind CSS (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script> tailwind.config = { theme: { extend: {} } }; </script>

  <!-- React 18 UMD + ReactDOM -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>

  <!-- Babel Standalone (pour transpiler JSX/TS directement dans le navigateur) -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <style>
    body { background: #f7fafc; } /* gris léger */
  </style>
</head>
<body class="antialiased">
  <div id="root" class="py-6"></div>

  <script type="text/babel" data-presets="react,typescript">
    const { useMemo, useState } = React;

    function formatNumberFR(n, options = {}) {
      return new Intl.NumberFormat("fr-FR", options).format(n);
    }

    // Nouvelle grille de complexité (max 10 sources)
    // Faible 1–2 (+0%), Modérée 3–4 (+15%), Élevée 5–6 (+30%), Forte 7–10 (+50%)
    function useComplexity(sources) {
      return React.useMemo(() => {
        let m = 1.0, l = "Faible", d = "+0%";
        if (sources >= 3 && sources <= 4) { m = 1.15; l = "Modérée"; d = "+15%"; }
        else if (sources >= 5 && sources <= 6) { m = 1.30; l = "Élevée"; d = "+30%"; }
        else if (sources >= 7 && sources <= 10) { m = 1.50; l = "Forte"; d = "+50%"; }
        // 1–2 reste "Faible" (+0%)
        return { multiplier: m, label: l, detail: d };
      }, [sources]);
    }

    function CalculateurRetraitements() {
      const [hoursPerPerson, setHoursPerPerson] = useState(4);
      const [people, setPeople] = useState(2);
      const [hourlyCost, setHourlyCost] = useState(60);
      const [sources, setSources] = useState(6); // 1–10

      const { multiplier, label: complexityLabel, detail: complexityDetail } = useComplexity(sources);

      const effectiveHours = useMemo(
        () => +(hoursPerPerson * people * multiplier).toFixed(1),
        [hoursPerPerson, people, multiplier]
      );
      const weeklyCost = useMemo(
        () => Math.round(effectiveHours * hourlyCost),
        [effectiveHours, hourlyCost]
      );

      const monthlyHours = useMemo(() => +(effectiveHours * 4.3).toFixed(1), [effectiveHours]);
      const monthlyCost  = useMemo(() => Math.round(weeklyCost * 4.3), [weeklyCost]);
      const annualHours  = useMemo(() => +(effectiveHours * 52).toFixed(1), [effectiveHours]);
      const annualCost   = useMemo(() => Math.round(weeklyCost * 52), [weeklyCost]);

      // Mobile : bouton pour ouvrir/fermer le calculateur
      const [isMobileOpen, setIsMobileOpen] = useState(false);

      return (
        <div className="w-full max-w-3xl mx-auto p-5">
          {/* Mobile - bouton d'activation */}
          <div className="sm:hidden mb-3">
            <button onClick={() => setIsMobileOpen(true)} className="w-full px-4 py-3 rounded-xl bg-[#0075F2] text-white text-base shadow">
              Estimer ma charge
            </button>
          </div>

          <div className={`bg-white rounded-2xl shadow-lg border border-gray-100 overflow-hidden ${isMobileOpen ? 'block' : 'hidden'} sm:block`}>
            {/* Header */}
            <div className="bg-[#0075F2] text-white p-6">
              <h1 className="text-2xl font-semibold">Mesurez la charge des retraitements de données</h1>
              <div className="sm:hidden mt-2">
                <button onClick={() => setIsMobileOpen(false)} className="px-3 py-1.5 rounded-lg bg-white/10 hover:bg-white/20 text-white text-sm">
                  Fermer
                </button>
              </div>
            </div>

            {/* Body */}
            <div className="p-5 grid grid-cols-1 md:grid-cols-2 gap-4">
              {/* Inputs */}
              <section className="space-y-3">
                <h2 className="text-sm font-semibold text-gray-700 uppercase tracking-wider">Paramètres</h2>

                {/* Heures par personne */}
                <div className="p-4 rounded-xl border border-gray-200 bg-gray-50/60">
                  <label htmlFor="hours" className="flex justify-between items-center gap-3 md:gap-6 font-medium text-gray-800 mb-2">
                    <span className="truncate md:whitespace-nowrap">Heures de retraitement / personne / semaine</span>
                    <span className="text-[#0075F2] whitespace-nowrap">{hoursPerPerson} h</span>
                  </label>
                  <input id="hours" type="range" min={0} max={10} step={0.25} value={hoursPerPerson}
                         onChange={(e) => setHoursPerPerson(parseFloat(e.target.value))}
                         className="w-full accent-[#0075F2]" />
                  <p className="mt-2 text-xs text-gray-600">Plage 0–10 h. Représente le temps moyen hebdomadaire passé à retraiter la donnée par personne.</p>
                </div>

                {/* Personnes */}
                <div className="p-4 rounded-xl border border-gray-200 bg-gray-50/60">
                  <label htmlFor="people" className="flex justify-between font-medium text-gray-800 mb-2">
                    <span>Nombre de personnes concernées</span>
                    <span className="text-[#0075F2]">{people}</span>
                  </label>
                  <input id="people" type="range" min={1} max={5} step={1} value={people}
                         onChange={(e) => setPeople(parseInt(e.target.value, 10))}
                         className="w-full accent-[#0075F2]" />
                  <p className="mt-2 text-xs text-gray-600">Plage 1–5. Incluez les profils Data/BI et métier impliqués.</p>
                </div>

                {/* Coût horaire */}
                <div className="p-4 rounded-xl border border-gray-200 bg-gray-50/60">
                  <label htmlFor="cost" className="flex justify-between font-medium text-gray-800 mb-2">
                    <span>Coût horaire moyen (€/h)</span>
                    <span className="text-[#0075F2]">{formatNumberFR(hourlyCost)} €</span>
                  </label>
                  <input id="cost" type="range" min={10} max={100} step={5} value={hourlyCost}
                         onChange={(e) => setHourlyCost(parseInt(e.target.value, 10))}
                         className="w-full accent-[#0075F2]" />
                  <p className="mt-2 text-xs text-gray-600">Plage 10–100 €/h. Salaire chargé + coûts externes éventuels.</p>
                </div>

                {/* Sources (MAJ : max 10) */}
                <div className="p-4 rounded-xl border border-gray-200 bg-gray-50/60">
                  <label htmlFor="sources" className="flex justify-between font-medium text-gray-800 mb-2">
                    <span>Nombre de sources de données</span>
                    <span className="text-[#0075F2]">{sources}</span>
                  </label>
                  <input id="sources" type="range" min={1} max={10} step={1} value={sources}
                         onChange={(e) => setSources(parseInt(e.target.value, 10))}
                         className="w-full accent-[#0075F2]" />
                  <p className="mt-2 text-xs text-gray-600">
                    Plage 1–10. <span className="font-medium">Complexité : {complexityLabel} ({complexityDetail})</span> · Coefficient {multiplier.toFixed(2)}
                  </p>
                </div>

                <div className="flex items-center gap-3">
                  <a
                    href="https://www.myreport.fr/ressource/demo-myreport/?utm_source=article&utm_medium=Calculateur+temps+perdu&utm_campaign=Responsable+data+Diff%C3%A9rences+reporting"
                    target="_blank" rel="noopener noreferrer"
                    className="px-3 py-2 rounded-xl bg-[#0075F2] text-white hover:opacity-90 shadow text-sm"
                  >Obtenir ma démo personnalisée</a>
                </div>
              </section>

              {/* Résultats */}
              <section className="space-y-3">
                <h2 className="text-sm font-semibold text-gray-700 uppercase tracking-wider">Résultats</h2>

                <div className="p-4 rounded-2xl border border-gray-200 bg-white">
                  <div className="flex items-center gap-2 mb-1">
                    <span className="text-xs bg-blue-50 text-[#0075F2] px-2 py-1 rounded-md border border-blue-100">Hebdomadaire</span>
                  </div>
                  <div className="grid grid-cols-1 sm:grid-cols-2 gap-3 mt-1">
                    <div>
                      <div className="text-sm text-gray-600">Heures effectives</div>
                      <div className="text-3xl font-semibold mt-1">{formatNumberFR(effectiveHours, { maximumFractionDigits: 1 })} h</div>
                      <div className="text-xs text-gray-500 mt-1">Heures × personnes × coefficient sources</div>
                    </div>
                    <div>
                      <div className="text-sm text-gray-600">Coût estimé</div>
                      <div className="text-3xl font-semibold mt-1">{formatNumberFR(weeklyCost)} €</div>
                      <div className="text-xs text-gray-500 mt-1">Heures effectives × coût horaire</div>
                    </div>
                  </div>
                </div>

                <div className="p-4 rounded-2xl border border-gray-200 bg-white">
                  <div className="flex items-center gap-2 mb-1">
                    <span className="text-xs bg-blue-50 text-[#0075F2] px-2 py-1 rounded-md border border-blue-100">Mensuel (indicatif)</span>
                  </div>
                  <div className="grid grid-cols-1 sm:grid-cols-2 gap-3 mt-1">
                    <div>
                      <div className="text-sm text-gray-600">Heures (≈ 4,3 sem.)</div>
                      <div className="text-3xl font-semibold mt-1">{formatNumberFR(monthlyHours, { maximumFractionDigits: 1 })} h</div>
                    </div>
                    <div>
                      <div className="text-sm text-gray-600">Coût indicatif</div>
                      <div className="text-3xl font-semibold mt-1">{formatNumberFR(monthlyCost)} €</div>
                    </div>
                  </div>
                </div>

                <div className="p-4 rounded-2xl border border-gray-200 bg-white">
                  <div className="flex items-center gap-2 mb-1">
                    <span className="text-xs bg-blue-50 text-[#0075F2] px-2 py-1 rounded-md border border-blue-100">Annuel (indicatif)</span>
                  </div>
                  <div className="grid grid-cols-1 sm:grid-cols-2 gap-3 mt-1">
                    <div>
                      <div className="text-sm text-gray-600">Heures (≈ 52 sem.)</div>
                      <div className="text-3xl font-semibold mt-1">{formatNumberFR(annualHours, { maximumFractionDigits: 1 })} h</div>
                    </div>
                    <div>
                      <div className="text-sm text-gray-600">Coût indicatif</div>
                      <div className="text-3xl font-semibold mt-1">{formatNumberFR(annualCost)} €</div>
                    </div>
                  </div>
                </div>

              </section>
            </div>
          </div>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById("root"));
    root.render(<CalculateurRetraitements />);
  </script>

  <!-- Émetteur postMessage pour auto-redimensionner l'iframe -->
  <script>
    (function () {
      function sendHeight() {
        var h = Math.max(
          document.documentElement.scrollHeight,
          document.body ? document.body.scrollHeight : 0
        );
        // IMPORTANT : remplace '*' par l’URL exacte de ton site WP pour plus de sécurité
        window.parent.postMessage({ type: 'calc-resize', height: h }, '*');
      }
      window.addEventListener('load', sendHeight);
      if ('ResizeObserver' in window) { new ResizeObserver(sendHeight).observe(document.body); }
      if (document.fonts && document.fonts.ready) { document.fonts.ready.then(sendHeight); }
      window.addEventListener('resize', sendHeight);
    })();
  </script>
</body>
</html>
