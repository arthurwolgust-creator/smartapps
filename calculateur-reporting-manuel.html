import React, { useMemo, useState, useEffect } from "react";
import { motion } from "framer-motion";
import { Calculator, Copy, Download, RefreshCcw, Info } from "lucide-react";

// ===== Utils =====
const eur = (n: number) =>
  n.toLocaleString("fr-FR", {
    style: "currency",
    currency: "EUR",
    maximumFractionDigits: 0,
  });

function NumberInput({
  value,
  onChange,
  step = 1,
  min = 0,
  suffix,
  className,
}: {
  value: number;
  onChange: (v: number) => void;
  step?: number;
  min?: number;
  suffix?: string;
  className?: string;
}) {
  return (
    <div className={`relative ${className ?? ""}`}>
      <input
        type="number"
        value={Number.isFinite(value) ? value : 0}
        min={min}
        step={step}
        onChange={(e) => onChange(parseFloat(e.target.value || "0"))}
        className="w-full rounded-2xl border border-gray-200 bg-white p-3 pr-16 text-sm font-medium text-gray-900 shadow-sm focus:outline-none focus:ring-2 focus:ring-[#0075F2] placeholder:text-gray-400"
      />
      {suffix ? (
        <span className="pointer-events-none absolute right-3 top-1/2 -translate-y-1/2 text-xs text-gray-500">
          {suffix}
        </span>
      ) : null}
    </div>
  );
}

function Label({ children, hint }: { children: React.ReactNode; hint?: string }) {
  return (
    <div className="flex items-center gap-2 text-sm font-medium text-gray-800">
      <span>{children}</span>
      {hint ? (
        <span className="group relative inline-flex items-center">
          <Info className="h-4 w-4 text-gray-400" />
          <span className="invisible group-hover:visible absolute left-5 top-5 z-10 w-64 rounded-xl bg-white p-3 text-xs shadow-xl ring-1 ring-gray-200">
            {hint}
          </span>
        </span>
      ) : null}
    </div>
  );
}

// ===== Model =====
const BRAND = {
  primary: "#0075F2",
  softBg: "#F7F9FC",
} as const;

const HOURLY_COST = 60; // € / h — hypothèse coût horaire moyen chargé

const REPORT_TYPES = [
  "Reporting financier",
  "Reporting comptable",
  "Reporting commercial",
  "Reporting Marketing",
  "Reporting RH",
  "Autre",
] as const;

type ReportType = typeof REPORT_TYPES[number];

const STEP_LABELS = [
  "Collecte des données (localiser + export)",
  "Retraitement & consolidation dans Excel",
  "Mise en forme du reporting (tableau + graphiques)",
] as const;

type StepHours = [number, number, number]; // heures / report / personne

const TYPE_PRESETS: Record<ReportType, StepHours> = {
  "Reporting financier": [3, 6, 3],
  "Reporting comptable": [4, 8, 4],
  "Reporting commercial": [2, 4, 2],
  "Reporting Marketing": [2, 3, 3],
  "Reporting RH": [2, 5, 3],
  "Autre": [2, 4, 2],
};

// ===== Main Component =====
export default function ManualReportingCostCalculator_Simplified() {
  // Variables
  const [type, setType] = useState<ReportType>("Reporting financier");
  const [recurrence, setRecurrence] = useState<number>(12); // nb de reportings / an
  const [people, setPeople] = useState<number>(1); // personnes impliquées
  const [stepHours, setStepHours] = useState<StepHours>(TYPE_PRESETS[type]);

  function onTypeChange(next: ReportType) {
    setType(next);
    setStepHours(TYPE_PRESETS[next]); // remet des valeurs par défaut simples
  }

  function updateStep(idx: number, v: number) {
    setStepHours((prev) => {
      const arr = [...prev] as StepHours;
      arr[idx] = Math.max(0, v);
      return arr;
    });
  }

  function reset() {
    setType("Reporting financier");
    setRecurrence(12);
    setPeople(1);
    setStepHours(TYPE_PRESETS["Reporting financier"]);
  }

  const computed = useMemo(() => {
    const hoursPerReportPerPerson = stepHours.reduce((a, h) => a + h, 0);
    const teamHoursPerReport = hoursPerReportPerPerson * people;
    const costPerReport = teamHoursPerReport * HOURLY_COST;

    const annualHours = teamHoursPerReport * recurrence;
    const annualCost = costPerReport * recurrence;
    const monthlyAvgCost = annualCost / 12;

    return {
      hoursPerReportPerPerson,
      teamHoursPerReport,
      costPerReport,
      annualHours,
      annualCost,
      monthlyAvgCost,
    };
  }, [stepHours, people, recurrence]);

  // ===== Dev self-tests (sanity checks, non-bloquants) =====
  useEffect(() => {
    try {
      const s = ["a", "b"].join("\n");
      console.assert(s === "a\nb", "Join with newline should produce 'a\\nb'");
      const csv = [["x"], ["y"]].map((r) => r.join(";")).join("\n");
      console.assert(csv.includes("\n"), "CSV should contain a newline between rows");
    } catch (e) {
      console.warn("Self-tests failed (non-bloquant):", e);
    }
  }, []);

  function copySummary() {
    const lines: string[] = [];
    lines.push("Calcul du coût du reporting manuel – Vue simple");
    lines.push("");
    lines.push(`Type de reporting: ${type}`);
    lines.push(`Récurrence / an: ${recurrence}`);
    lines.push(`Personnes impliquées: ${people}`);
    lines.push(`Hypothèse coût horaire chargé: ${HOURLY_COST} €/h`);
    lines.push("");
    STEP_LABELS.forEach((lab, i) => {
      lines.push(`• ${lab}: ${stepHours[i]} h / report (par personne)`);
    });
    lines.push("");
    lines.push(`Heures / report – par personne: ${computed.hoursPerReportPerPerson.toFixed(1)} h`);
    lines.push(`Heures / report – équipe: ${computed.teamHoursPerReport.toFixed(1)} h`);
    lines.push(`Coût / report: ${eur(computed.costPerReport)}`);
    lines.push(`Heures / an: ${computed.annualHours.toFixed(1)} h`);
    lines.push(`Coût / an: ${eur(computed.annualCost)}`);
    lines.push(`Coût moyen / mois: ${eur(computed.monthlyAvgCost)}`);
    navigator.clipboard.writeText(lines.join("\n"));
    alert("Résumé copié dans le presse-papiers ✅");
  }

  function exportCSV() {
    const header = [
      "Type de reporting",
      "Récurrence/an",
      "Personnes",
      "Coût horaire (EUR/h)",
      "Étape",
      "Heures / report (par pers)",
      "Heures équipe / report",
      "Coût / report (EUR)",
      "Heures / an",
      "Coût / an (EUR)",
      "Coût moyen / mois (EUR)",
    ];
    const rows: (string | number)[][] = [];

    // Lignes par étape
    STEP_LABELS.forEach((lab, i) => {
      const teamStepHours = stepHours[i] * people;
      const stepCostPerReport = teamStepHours * HOURLY_COST;
      rows.push([
        type,
        recurrence,
        people,
        HOURLY_COST,
        lab,
        stepHours[i],
        teamStepHours.toFixed(1),
        Math.round(stepCostPerReport),
        "",
        "",
        "",
      ]);
    });

    // Totaux
    rows.push([
      type,
      recurrence,
      people,
      HOURLY_COST,
      "TOTAL",
      computed.hoursPerReportPerPerson.toFixed(1),
      computed.teamHoursPerReport.toFixed(1),
      Math.round(computed.costPerReport),
      computed.annualHours.toFixed(1),
      Math.round(computed.annualCost),
      Math.round(computed.monthlyAvgCost),
    ]);

    const csv = [header, ...rows]
      .map((r) => r.map((c) => `"${String(c).replaceAll('"', '""')}"`).join(";"))
      .join("\n");

    const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "cout-reporting-manuel-simple.csv";
    a.click();
    URL.revokeObjectURL(url);
  }

  return (
    <div className="mx-auto max-w-3xl p-6 lg:p-8">
      <motion.div initial={{ opacity: 0, y: 8 }} animate={{ opacity: 1, y: 0 }} transition={{ duration: 0.4 }}>
        {/* Header brand */}
        <div className="mb-6 rounded-2xl bg-white p-5 shadow-sm ring-1 ring-[#0075F2]/15">
          <div className="flex items-center gap-3">
            <div className="flex h-12 w-12 items-center justify-center rounded-2xl" style={{ backgroundColor: `#0075F21A` }}>
              <Calculator className="h-6 w-6" style={{ color: "#0075F2" }} />
            </div>
            <div className="flex-1">
              <h1 className="text-2xl font-semibold text-gray-900">Calculateur – Coût du reporting manuel</h1>
              <p className="text-sm text-gray-600">Variables minimales, résultats clairs.</p>
            </div>
          </div>
        </div>

        {/* Bloc Variables */}
        <div className="mb-6 rounded-2xl bg-white p-5 shadow-sm ring-1 ring-gray-100">
          <div className="mb-3 text-sm font-semibold text-gray-900">Variables</div>

          <div className="grid grid-cols-1 gap-3 sm:grid-cols-2">
            <div className="sm:col-span-2">
              <Label>Type de reporting</Label>
              <select
                value={type}
                onChange={(e) => onTypeChange(e.target.value as ReportType)}
                className="mt-2 w-full rounded-2xl border border-gray-200 bg-white p-3 text-sm font-medium text-gray-900 shadow-sm focus:outline-none focus:ring-2 focus:ring-[#0075F2]"
              >
                {REPORT_TYPES.map((opt) => (
                  <option key={opt} value={opt}>{opt}</option>
                ))}
              </select>
            </div>

            <div>
              <Label hint="Nombre de fois où ce reporting est produit chaque année (ex: 12 pour mensuel)">Récurrence par an</Label>
              <NumberInput value={recurrence} onChange={setRecurrence} step={1} suffix="/an" />
            </div>

            <div>
              <Label>Personnes impliquées</Label>
              <NumberInput value={people} onChange={setPeople} step={1} suffix="pers" />
            </div>
          </div>

          <div className="mt-4">
            <div className="mb-2 text-sm font-semibold text-gray-900">Étapes du reporting (heures par report et par personne)</div>
            <div className="grid grid-cols-12 items-end gap-3 text-xs font-medium text-gray-500">
              <div className="col-span-7">Étape</div>
              <div className="col-span-5">Heures / report <span className="text-gray-400">(par pers)</span></div>
            </div>
            {STEP_LABELS.map((lab, i) => (
              <div key={i} className="mt-2 grid grid-cols-12 items-center gap-3">
                <div className="col-span-7 text-sm text-gray-800">{lab}</div>
                <NumberInput
                  value={stepHours[i]}
                  onChange={(v) => updateStep(i, v)}
                  step={0.5}
                  suffix="h"
                  className="col-span-5"
                />
              </div>
            ))}
            <div className="mt-3 rounded-xl p-3 text-xs" style={{ backgroundColor: BRAND.softBg }}>
              Hypothèse utilisée pour le calcul : <b>{HOURLY_COST} €/h</b> (coût horaire moyen chargé).
            </div>
          </div>
        </div>

        {/* Bloc Résultats */}
        <div className="rounded-2xl bg-white p-5 shadow-sm ring-1 ring-gray-100">
          <div className="mb-3 text-sm font-semibold text-gray-900">Résultats</div>
          <div className="grid grid-cols-1 gap-3 sm:grid-cols-2">
            <div className="rounded-xl p-3" style={{ backgroundColor: BRAND.softBg }}>
              <div className="text-xs text-gray-600">Heures / report – par personne</div>
              <div className="mt-1 text-xl font-semibold text-gray-900">{computed.hoursPerReportPerPerson.toFixed(1)} h</div>
            </div>
            <div className="rounded-xl p-3" style={{ backgroundColor: BRAND.softBg }}>
              <div className="text-xs text-gray-600">Heures / report – équipe</div>
              <div className="mt-1 text-xl font-semibold text-gray-900">{computed.teamHoursPerReport.toFixed(1)} h</div>
            </div>
            <div className="rounded-xl p-3" style={{ backgroundColor: BRAND.softBg }}>
              <div className="text-xs text-gray-600">Coût / report</div>
              <div className="mt-1 text-xl font-semibold text-gray-900">{eur(computed.costPerReport)}</div>
            </div>
            <div className="rounded-xl p-3" style={{ backgroundColor: BRAND.softBg }}>
              <div className="text-xs text-gray-600">Heures / an</div>
              <div className="mt-1 text-xl font-semibold text-gray-900">{computed.annualHours.toFixed(1)} h</div>
            </div>
            <div className="rounded-xl p-3" style={{ backgroundColor: BRAND.softBg }}>
              <div className="text-xs text-gray-600">Coût / an</div>
              <div className="mt-1 text-xl font-semibold text-gray-900">{eur(computed.annualCost)}</div>
            </div>
            <div className="rounded-xl p-3" style={{ backgroundColor: BRAND.softBg }}>
              <div className="text-xs text-gray-600">Coût moyen / mois</div>
              <div className="mt-1 text-xl font-semibold text-gray-900">{eur(computed.monthlyAvgCost)}</div>
            </div>
          </div>

          {/* Actions */}
          <div className="mt-4 flex flex-col gap-2 sm:flex-row sm:items-center">
            <button onClick={copySummary} className="inline-flex items-center gap-2 rounded-xl bg-[#0075F2] px-4 py-2 text-sm font-medium text-white shadow-sm hover:brightness-110">
              <Copy className="h-4 w-4"/> Copier le résumé
            </button>
            <button onClick={exportCSV} className="inline-flex items-center gap-2 rounded-xl bg-white px-4 py-2 text-sm font-medium text-[#0075F2] shadow-sm ring-1 ring-[#0075F2]/30 hover:bg-[#0075F2]/5">
              <Download className="h-4 w-4"/> Exporter (.csv)
            </button>
            <button onClick={reset} className="inline-flex items-center gap-2 rounded-xl bg-white px-4 py-2 text-sm font-medium text-gray-800 shadow-sm ring-1 ring-gray-200 hover:bg-gray-50">
              <RefreshCcw className="h-4 w-4"/> Réinitialiser
            </button>
          </div>
        </div>

      </motion.div>
    </div>
  );
}
